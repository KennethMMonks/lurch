{"version":3,"sources":["lde.litcoffee"],"names":["EventEmitter","Feedback","InputStructure","InputTree","Structure","deserializeIfNeeded","expectedArgumentCount","feedback","functions","isInTheInputTree","slice","require","WorkerGlobalScope","importScripts","self","attr","id","trackIDs","getInputTree","structure","parent","jsonOrInputStructure","fromJSON","insert","newChild","parentID","insertionIndex","newInstance","instanceWithID","children","length","setup","insertChild","subtreeID","subtree","removeFromParent","untrackIDs","replace","newTree","replaceWith","setAttribute","key","value","clearAttributes","delete","addEventListener","event","args","command","feedbackData","ref","subject","data","call","postMessage","toJSON","apply","window","EventTarget","exports","addListener","dispatchEvent","Event","emit"],"mappings":"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","file":"lde.js","sourcesContent":["\n# Lurch Deductive Engine (LDE) Main File\n\nThis file imports all the other modules in this repository and exposes them\nthrough its `exports` member, so that clients can import just this one file\nand have access to all the functionality from all the source files in this\nrepository.\n\nImport the structure class; it will be exported to clients as well using\ncode at the end of this file.  The following lines detect whether this is\nbeing used in Node.js or a WebWorker, or a WebWorker-like background thread\nwithin Node.js, and do the right thing in any case.\n\n    if require?\n        { Structure } = require './structure'\n        { InputStructure } = require './input-structure'\n    else if WorkerGlobalScope?\n        importScripts 'structure.js'\n        importScripts 'input-structure.js'\n    else if self?.importScripts?\n        importScripts 'release/structure.js'\n        importScripts 'release/input-structure.js'\n\n## The Input Tree\n\nThe Input Tree is a global instance of the `InputStructure` class,\nrepresenting the content of the user's document as expressed to this module\nby the client.  It has the special ID \"root.\"\n\n    InputTree = ( new InputStructure ).attr 'id' : 'root'\n    InputTree.trackIDs()\n\nClients should treat the global Input Tree as read-only, *except* through\nthe API provided in [the following section](#the-main-api).  But we provide\nthe following function for two reasons.\n\n 1. It is usable to *read* the Input Tree.  Although the client could also\n    use it to manipulate that tree, doing so violates the preconditions of\n    this module, and thus discards any behavior guarantees it provides.\n 2. As an important special case of the previous, it is usable in the unit\n    testing suite to verify that the API below is manipulating the tree\n    according to its specifications.\n\nThe following function returns the root of the Input Tree structure.\n\n    functions = { }\n    functions.getInputTree = -> InputTree\n\n## Utilities\n\nWe create a function for use privately in this module, for verifying that a\nparticular structure is a descendant of the Input Tree.\n\n    isInTheInputTree = ( structure ) ->\n        while structure instanceof InputStructure\n            if structure is InputTree then return yes\n            structure = structure.parent()\n        no\n\nWe create another function for use privately in this module, which takes a\nparameter that may be an `InputStructure` instance or a JSON serialization\nthereof.  It returns an `InputStructure` instance; in the first case by\ndoing nothing, and in the second case by attempting to deserialize it.\n\n    deserializeIfNeeded = ( jsonOrInputStructure ) ->\n        if jsonOrInputStructure instanceof InputStructure\n            jsonOrInputStructure\n        else\n            Structure.fromJSON jsonOrInputStructure\n\n## The Main API\n\nThis module presents to clients a four-function API defined in this section.\nEach of these functions manipulates the global Input Tree.\n\nThe following insertion function deserializes the given structure from JSON,\nfinds the descendant of the Input Tree that has the given ID, and inserts\nthe deserialized version as one of its children, at the given index. If\nanything goes wrong in that process then it does nothing.  The ID must be\nthe ID of a Structure, as defined in that class (a string ID stored in the\nattribute \"id\").\n\nIt is also permitted for the first parameter to be an actual structure\ninstance rather than a JSON serialization of one.  This is primarily useful\nin very simple clients, where the LDE module will be loaded directly into\nthe client.\n\nAll newly inserted structures and their descendants have all their IDs\ntracked.\n\n    functions.insert = ( newChild, parentID, insertionIndex ) ->\n        if ( parent = Structure.instanceWithID parentID )? and \\\n           ( 0 <= insertionIndex <= parent.children().length ) and \\\n           ( isInTheInputTree parent ) and \\\n           ( newInstance = deserializeIfNeeded( newChild ).setup() )? and \\\n           ( newInstance instanceof InputStructure )\n            parent.insertChild newInstance, insertionIndex\n            newInstance.trackIDs()\n\nThe following function finds the descendant of the global Input Tree that\nhas the given ID and, assuming such a structure exists, removes it from its\nparent and stops tracking all IDs within it.\n\n    functions.delete = ( subtreeID ) ->\n        if ( subtree = Structure.instanceWithID subtreeID )? and \\\n           ( isInTheInputTree subtree ) and subtree isnt InputTree\n            subtree.removeFromParent()\n            subtree.untrackIDs()\n\nThe following function finds the descendant of the global Input Tree that\nhas the given ID and, assuming such a structure exists, deserializes the\nsecond argument as a Structure object and uses it to replace the original\nstructure in the Input Tree.  The deserialized version will have all of\nthe IDs in its hierarchy tracked.  This module will also stop tracking all\nIDs in the structure that was removed.\n\nThis functionl, also, permits passing an actual `InputStructure` instance as\nthe second argument, rather than a serialized version.\n\n    functions.replace = ( subtreeID, newTree ) ->\n        if ( subtree = Structure.instanceWithID subtreeID )? and \\\n           ( isInTheInputTree subtree ) and subtree isnt InputTree and \\\n           ( newInstance = deserializeIfNeeded( newTree ).setup() )? and \\\n           ( newInstance instanceof InputStructure )\n            subtree.replaceWith newInstance\n            subtree.untrackIDs()\n            newInstance.trackIDs()\n\nThe following function finds the descendant of the global Input Tree that\nhas the given ID and, assuming such a structure exists, calls its member\nfunction for setting an attribute with the given key and value.  As per the\nrequirements of the `Structure.setAttribute` function, be sure to provide\nonly values that are amenable to `JSON.stringify`.\n\n    functions.setAttribute = ( subtreeID, key, value ) ->\n        if ( subtree = Structure.instanceWithID subtreeID )? and \\\n           isInTheInputTree subtree\n            if key is 'id' then subtree.untrackIDs no\n            if typeof value is 'undefined'\n                subtree.clearAttributes key\n            else\n                subtree.setAttribute key, value\n            if key is 'id' then subtree.trackIDs no\n\n## Event Listeners\n\nIf the LDE detects that it is being run in a background thread, it will set\nup listeners for messages from the parent thread.  These listeners handle\nmessages of five types:\n\n * `insert`, with three arguments, which calls the `insert` function defined\n   above and sends no messages back\n * `delete`, with one argument, which calls `delete` and sends no messages\n * `replace`, with two arguments, which calls `replace` and sends no\n   messages\n * `setAttribute`, with three arguments, which calls `setAttribute` and\n   sends no messages\n * `getInputTree`, with zero arguments, which sends back a message\n   containing the JSON serialized form of the document, as fetched using the\n   `getInputTree` function defined above\n\n\n    if WorkerGlobalScope? or self?.importScripts?\n\nHere are the numbers of arguments we accept for each message we accept.\n\n        expectedArgumentCount =\n            insert : 3\n            delete : 1\n            replace : 2\n            setAttribute : 3\n            getInputTree : 0\n\nMessages received expect data arrays of the form `[ command, args... ]`.\n\n        self.addEventListener 'message', ( event ) ->\n            [ command, args... ] = event.data\n\nAnything with the right number of arguments is passed on to the\ncorresponding function.  That function may or may not do anything, depending\non whether the data is in the correct form.\n\n            if expectedArgumentCount[command] is args.length\n                if command is 'getInputTree'\n                    self.postMessage functions.getInputTree().toJSON()\n                else\n                    functions[command] args...\n\nWe also add the following function that is useless in production, but is\nuseful in testing.  It transmits feedback about any given node in the\nInput Tree.\n\n            if command is 'sendFeedback'\n                [ id, feedbackData ] = args\n                subject = Structure.instanceWithID id\n                if subject?.feedback?\n                    subject.feedback feedbackData\n                else\n                    self.postMessage \"No such Structure: #{id}\"\n\n## Feedback\n\nIf we have been loaded in node.js or the browser, create a global feedback\nmechanism called `Feedback`, an instance of `EventTarget` or `EventEmitter`,\ndepending on whether this is node.js or the browser.\n\n    if window? and EventTarget?\n        Feedback = window.Feedback = new EventTarget() # browser\n    if require? and exports?\n        EventEmitter = require 'events'\n        Feedback = exports.Feedback = new EventEmitter() # node\n        Feedback.addEventListener = Feedback.addListener # make API same\n\nWe also create a function global to this module that implements the sending\nof feedback to our context.  In node.js or the browser, we emit an event\nfrom the `Feedback` object just created.  If we are running in a `WebWorker`\n(or node.js's equivalent of one) then we post a message to our parent\ninstead.\n\n    feedback = ( feedbackData ) ->\n        if Feedback?.dispatchEvent?\n            event = new Event 'feedback'\n            for own key, value of feedbackData\n                event[key] = value\n            Feedback.dispatchEvent event\n        else if Feedback?.emit?\n            Feedback.emit 'feedback', feedbackData\n        else if self?.postMessage?\n            self.postMessage feedbackData\n\nInstall that function in the `Structure` class, overriding the stub class\nmethod that module installs in itself.\n\n    Structure.feedback = feedback\n\nAnd export anything else that needs exporting.\n\n    if exports?\n        exports.Structure = Structure\n        exports.InputStructure = InputStructure\n        exports.insert = functions.insert\n        exports.delete = functions.delete\n        exports.replace = functions.replace\n        exports.setAttribute = functions.setAttribute\n        exports.getInputTree = functions.getInputTree\n"]}
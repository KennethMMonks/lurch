var InputStructure,OM,OutputExpression,OutputRule,OutputStructure,Structure,extend=function(t,e){function r(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,slice=[].slice,indexOf=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};"undefined"!=typeof require&&null!==require?(Structure=require("./structure").Structure,InputStructure=require("./input-structure").InputStructure,OM=require("openmath-js").OM):"undefined"!=typeof WorkerGlobalScope&&null!==WorkerGlobalScope?(null==WorkerGlobalScope.Structure&&(importScripts("structure.js"),importScripts("input-structure.js")),null==WorkerGlobalScope.OM&&importScripts("openmath.js")):null!=("undefined"!=typeof self&&null!==self?self.importScripts:void 0)&&(null==self.Structure&&(importScripts("release/structure.js"),importScripts("release/input-structure.js")),null==self.OM&&importScripts("node_modules/openmath-js/openmath.js")),OutputStructure=function(t){function e(){var t,r,n;e.__super__.constructor.apply(this,arguments),this.markDirty(),(r=null!=(n=(t=Structure.prototype.subclasses.InputStructure).prototype.instancesBeingInterpreted)?n.length:void 0)&&(this.origin=t.prototype.instancesBeingInterpreted[r-1]),this.enableFeedback(!0,!1)}return extend(e,Structure),e.prototype.className=Structure.addSubclass("OutputStructure",e),e.prototype.markDirty=function(t){return null==t&&(t=!0),this.dirty=t},e.prototype.addConnectionOrigin=function(t,r,n){var i,o,u;if(i=Structure.prototype.subclasses.InputStructure,r instanceof e&&(o=null!=(u=i.prototype.instancesBeingInterpreted)?u.length:void 0))return n._origin=i.prototype.instancesBeingInterpreted[o-1].id()},e.prototype.feedback=function(t){var e;return this.sendingFeedback?null!=(e=this.origin)?e.feedback(t):void 0:this.feedbackStore.push(t)},e.prototype.enableFeedback=function(t,e){var r,n,i,o;if(null==t&&(t=!0),null==e&&(e=!1),(this.sendingFeedback=t)&&e)for(n=0,i=(o=this.feedbackStore).length;n<i;n++)r=o[n],this.feedback(r);return this.feedbackStore=[]},e.prototype.hasLabel=function(t){return!1},e.lookUpIn=function(t,e){var r,n,i,o;for(n=0,i=(o=e.slice(0).reverse()).length;n<i;n++)if((r=o[n]).hasLabel(t))return r},e.prototype.lookUp=function(t){return this.firstAccessible(function(e){return e.hasLabel(t)})},e.prototype.lookUpAll=function(t){return this.allAccessibles(function(e){return e.hasLabel(t)})},e.prototype.lookUpAllCitations=function(){var t,e,r,n,i,o,u,s,a,c,p,l,h,f,d,b,y,v,O,g,S,m;for(g={premises:{connections:[],labels:[]},reasons:{connections:[],labels:[]}},n=0,a=(b=this.getConnectionsOut()).length;n<a;n++)for(e=b[n],r=this.getConnectionData(e),i=0,c=(y=["premise","reason"]).length;i<c;i++)m=y[i],(null!=r?r.type:void 0)===m+" citation"&&null!=(S=this.getConnectionTarget(e))&&g[m+"s"].connections.push({cited:S.id(),id:e});for(o=0,p=(v=["premise","reason"]).length;o<p;o++)if(m=v[o],(s=this.getAttribute(m+" citations"))&&s instanceof Array)for(f=0,l=s.length;f<l;f++)for(u=s[f],d=0,h=(O=this.lookUpAll(u).reverse()).length;d<h;d++)t=O[d],g[m+"s"].labels.push({cited:t.id(),label:u});return g},e.prototype.justChanged=function(){var t;return"function"==typeof(t=e.prototype).instanceJustChanged?t.instanceJustChanged(this):void 0},e}(),OutputExpression=function(t){function e(){var t,r;switch(r=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],r){case"int":case"flo":case"str":case"byt":case"var":e.__super__.constructor.call(this),this.setAttribute("OM type",r),this.setAttribute("OM atomic value",t[0]);break;case"sym":e.__super__.constructor.call(this),this.setAttribute("OM type",r),this.setAttribute("OM atomic value",t);break;case"bin":e.__super__.constructor.apply(this,t.slice(1)),this.setAttribute("OM type",r),this.setAttribute("OM bound indices",t[0]);break;case"app":case"err":e.__super__.constructor.apply(this,t),this.setAttribute("OM type",r);break;default:e.__super__.constructor.call(this),this.setAttribute("OM type","err")}}return extend(e,OutputStructure),e.prototype.className=Structure.addSubclass("OutputExpression",e),e.prototype.toOpenMath=function(){var t,e,r,n,i,o,u,s,a;switch(s=this.getAttribute("OM type")){case"int":case"flo":case"str":case"byt":case"var":return new OM[s](this.getAttribute("OM atomic value"));case"sym":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM[s],this.getAttribute("OM atomic value"),function(){});case"app":case"err":return r=function(){var t,r,n,i;for(i=[],t=0,r=(n=this.children()).length;t<r;t++)e=n[t],i.push(e.toOpenMath());return i}.call(this),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM[s],r,function(){});case"bin":return o=this.getAttribute("OM bound indices"),a=function(){var t,e,r;for(r=[],t=0,e=o.length;t<e;t++)i=o[t],r.push(OM.var(this.children()[i].getAttribute("OM atomic value")));return r}.call(this),u=function(){var t,e,r;for(r=[],i=t=0,e=this.children().length;0<=e?t<e:t>e;i=0<=e?++t:--t)indexOf.call(o,i)<0&&r.push(i);return r}.call(this),n=this.children()[u[0]].toOpenMath(),t=this.children()[u[1]].toOpenMath(),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM.bin,[n].concat(slice.call(a),[t]),function(){});default:throw"Not a valid OpenMath type: "+s}},e.fromOpenMath=function(t){var r,n,i,o,u,s,a;switch(i=function(){var r,i,o,u;for(u=[],r=0,i=(o=t.children).length;r<i;r++)n=o[r],u.push(e.fromOpenMath(n));return u}(),t.type){case"i":return new e("int",t.value);case"f":return new e("flo",t.value);case"st":return new e("str",t.value);case"ba":return new e("byt",t.value);case"sy":return new e("sym",t.name,t.cd,t.uri);case"v":return new e("var",t.name);case"a":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["app"].concat(slice.call(i)),function(){});case"bi":return a=function(){var r,n,i,o;for(o=[],r=0,n=(i=t.variables).length;r<n;r++)s=i[r],o.push(new e("var",s.name));return o}(),o=e.fromOpenMath(t.symbol),r=e.fromOpenMath(t.body),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["bin",function(){u=[];for(var t=1,e=i.length;1<=e?t<e:t>e;1<=e?t++:t--)u.push(t);return u}.apply(this),o].concat(slice.call(a),[r]),function(){});case"e":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["err",e.fromOpenMath(t.symbol)].concat(slice.call(i)),function(){});default:throw"This should never happen - how did an OMNode instance get type "+t.type+"?"}},e}(),OM.prototype.toOutputExpression=function(){return OutputExpression.fromOpenMath(this)},OutputRule=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,OutputStructure),e.prototype.className=Structure.addSubclass("OutputRule",e),e.prototype.validateStep=function(t,e,r){return t.feedback({type:"validation result",validity:"indeterminate",message:"No real validation was performed."}),r()},e.basicValidate=function(t,r){var n,i;return this.enableFeedback(!1),i=this.lastCitationLookup.reasons,i=i.connections.concat(i.labels),(n=function(o){return function(){var u,s,a;return 0===i.length?(u=o.feedbackStore,o.enableFeedback(!0,!1),u.length>0&&o.feedback({type:"validation result",validity:"invalid",components:u}),r()):(s=i.shift(),null==(a=Structure.instanceWithID(s.cited))?(o.enableFeedback(!0,!1),o.feedback({type:"validation result",validity:"invalid",message:"Internal error: No Structure with ID "+s.cited,missingID:s.cited}),r()):a instanceof e?a.validateStep(o,t,function(){var t;return"valid"===(null!=(t=o.feedbackStore[o.feedbackStore.length-1])?t.validity:void 0)?(o.enableFeedback(!0,!1),o.feedback(t),r()):n()}):(o.enableFeedback(!0,!1),o.feedback({type:"validation result",validity:"invalid",message:"You cited a non-rule as a reason.",nonRule:s.cited}),r()))}}(this))()},e}(),"undefined"!=typeof exports&&null!==exports&&(exports.OutputStructure=OutputStructure,exports.OutputExpression=OutputExpression,exports.OM=exports.OMNode=OM);
//# sourceMappingURL=output-structure.js.map

var FOM,InputStructure,OM,OutputExpression,OutputRule,OutputStructure,Structure,TemplateRule,extend=function(t,e){function r(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,slice=[].slice,indexOf=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};"undefined"!=typeof require&&null!==require?(Structure=require("./structure").Structure,InputStructure=require("./input-structure").InputStructure,OM=require("openmath-js").OM,FOM=require("first-order-matching")):"undefined"!=typeof WorkerGlobalScope&&null!==WorkerGlobalScope?(null==WorkerGlobalScope.Structure&&(importScripts("structure.js"),importScripts("input-structure.js")),null==WorkerGlobalScope.OM&&importScripts("openmath.js"),null==WorkerGlobalScope.metavariableSymbol&&importScripts("first-order-matching.js")):null!=("undefined"!=typeof self&&null!==self?self.importScripts:void 0)&&(null==self.Structure&&(importScripts("release/structure.js"),importScripts("release/input-structure.js")),null==self.OM&&importScripts("node_modules/openmath-js/openmath.js"),null==self.metavariableSymbol&&importScripts("node_modules/first-order-matching/first-order-matching.js")),OutputStructure=function(t){function e(){var t,r,n;e.__super__.constructor.apply(this,arguments),this.markDirty(),(r=null!=(n=(t=Structure.prototype.subclasses.InputStructure).prototype.instancesBeingInterpreted)?n.length:void 0)&&(this.origin=t.prototype.instancesBeingInterpreted[r-1]),this.enableFeedback(!0,!1)}return extend(e,Structure),e.prototype.className=Structure.addSubclass("OutputStructure",e),e.prototype.markDirty=function(t){return null==t&&(t=!0),this.dirty=t},e.prototype.addConnectionOrigin=function(t,r,n){var i,u,o;if(i=Structure.prototype.subclasses.InputStructure,r instanceof e&&(u=null!=(o=i.prototype.instancesBeingInterpreted)?o.length:void 0))return n._origin=i.prototype.instancesBeingInterpreted[u-1].id()},e.prototype.feedback=function(t){var e;return this.sendingFeedback?null!=(e=this.origin)?e.feedback(t):void 0:this.feedbackStore.push(t)},e.prototype.enableFeedback=function(t,e){var r,n,i,u;if(null==t&&(t=!0),null==e&&(e=!1),(this.sendingFeedback=t)&&e)for(n=0,i=(u=this.feedbackStore).length;n<i;n++)r=u[n],this.feedback(r);return this.feedbackStore=[]},e.prototype.hasLabel=function(t){return!1},e.lookUpIn=function(t,e){var r,n,i,u;for(n=0,i=(u=e.slice(0).reverse()).length;n<i;n++)if((r=u[n]).hasLabel(t))return r},e.prototype.lookUp=function(t){return this.firstAccessible(function(e){return e.hasLabel(t)})},e.prototype.lookUpAll=function(t){return this.allAccessibles(function(e){return e.hasLabel(t)})},e.prototype.lookUpAllCitations=function(){var t,e,r,n,i,u,o,a,s,c,l,p,d,f,h,y,b,v,O,g,m,S;for(g={premises:{connections:[],labels:[]},reasons:{connections:[],labels:[]}},n=0,a=(y=this.getConnectionsOut()).length;n<a;n++)for(e=y[n],r=this.getConnectionData(e),i=0,s=(b=["premise","reason"]).length;i<s;i++)S=b[i],(null!=r?r.type:void 0)===S+" citation"&&null!=(m=this.getConnectionTarget(e))&&g[S+"s"].connections.push({cited:m.id(),id:e});for(d=0,c=(v=["premise","reason"]).length;d<c;d++)if(S=v[d],(o=this.getAttribute(S+" citations"))&&o instanceof Array)for(f=0,l=o.length;f<l;f++)for(u=o[f],h=0,p=(O=this.lookUpAll(u).reverse()).length;h<p;h++)t=O[h],g[S+"s"].labels.push({cited:t.id(),label:u});return g},e.prototype.justChanged=function(){var t;return"function"==typeof(t=e.prototype).instanceJustChanged?t.instanceJustChanged(this):void 0},e}(),OutputExpression=function(t){function e(){var t,r;switch(r=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],r){case"int":case"flo":case"str":case"byt":case"var":e.__super__.constructor.call(this),this.setAttribute("OM type",r),this.setAttribute("OM atomic value",t[0]);break;case"sym":e.__super__.constructor.call(this),this.setAttribute("OM type",r),this.setAttribute("OM atomic value",t);break;case"bin":e.__super__.constructor.apply(this,t.slice(1)),this.setAttribute("OM type",r),this.setAttribute("OM bound indices",t[0]);break;case"app":case"err":e.__super__.constructor.apply(this,t),this.setAttribute("OM type",r);break;default:e.__super__.constructor.call(this),this.setAttribute("OM type","err")}}return extend(e,OutputStructure),e.prototype.className=Structure.addSubclass("OutputExpression",e),e.prototype.toOpenMath=function(){var t,e,r,n,i,u,o,a,s;switch(a=this.getAttribute("OM type")){case"int":case"flo":case"str":case"byt":case"var":return new OM[a](this.getAttribute("OM atomic value"));case"sym":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM[a],this.getAttribute("OM atomic value"),function(){});case"app":case"err":return r=function(){var t,r,n,i;for(i=[],t=0,r=(n=this.children()).length;t<r;t++)e=n[t],i.push(e.toOpenMath());return i}.call(this),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM[a],r,function(){});case"bin":return u=this.getAttribute("OM bound indices"),s=function(){var t,e,r;for(r=[],t=0,e=u.length;t<e;t++)i=u[t],r.push(OM.var(this.children()[i].getAttribute("OM atomic value")));return r}.call(this),o=function(){var t,e,r;for(r=[],i=t=0,e=this.children().length;0<=e?t<e:t>e;i=0<=e?++t:--t)indexOf.call(u,i)<0&&r.push(i);return r}.call(this),n=this.children()[o[0]].toOpenMath(),t=this.children()[o[1]].toOpenMath(),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM.bin,[n].concat(slice.call(s),[t]),function(){});default:throw"Not a valid OpenMath type: "+a}},e.fromOpenMath=function(t){var r,n,i,u,o,a,s;switch(i=function(){var r,i,u,o;for(o=[],r=0,i=(u=t.children).length;r<i;r++)n=u[r],o.push(e.fromOpenMath(n));return o}(),t.type){case"i":return new e("int",t.value);case"f":return new e("flo",t.value);case"st":return new e("str",t.value);case"ba":return new e("byt",t.value);case"sy":return new e("sym",t.name,t.cd,t.uri);case"v":return new e("var",t.name);case"a":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["app"].concat(slice.call(i)),function(){});case"bi":return s=function(){var r,n,i,u;for(u=[],r=0,n=(i=t.variables).length;r<n;r++)a=i[r],u.push(new e("var",a.name));return u}(),u=e.fromOpenMath(t.symbol),r=e.fromOpenMath(t.body),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["bin",function(){o=[];for(var t=1,e=i.length;1<=e?t<e:t>e;1<=e?t++:t--)o.push(t);return o}.apply(this),u].concat(slice.call(s),[r]),function(){});case"e":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["err",e.fromOpenMath(t.symbol)].concat(slice.call(i)),function(){});default:throw"This should never happen - how did an OMNode instance get type "+t.type+"?"}},e}(),OM.prototype.toOutputExpression=function(){return OutputExpression.fromOpenMath(this)},OutputRule=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,OutputStructure),e.prototype.className=Structure.addSubclass("OutputRule",e),e.prototype.validateStep=function(t,e,r){return t.feedback({type:"validation result",validity:"indeterminate",message:"No real validation was performed."}),r()},e.basicValidate=function(t,r){var n,i;return this.enableFeedback(!1),i=this.lastCitationLookup.reasons,i=i.connections.concat(i.labels),(n=function(u){return function(){var o,a,s;return 0===i.length?(o=u.feedbackStore,u.enableFeedback(!0,!1),o.length>1?u.feedback({type:"validation result",validity:"invalid",components:o}):1===o.length&&u.feedback(o[0]),r()):(a=i.shift(),null==(s=Structure.instanceWithID(a.cited))?(u.enableFeedback(!0,!1),u.feedback({type:"validation result",validity:"invalid",message:"Internal error: No Structure with ID "+a.cited,missingID:a.cited}),r()):s instanceof e?s.validateStep(u,t,function(){var t;return"valid"===(null!=(t=u.feedbackStore[u.feedbackStore.length-1])?t.validity:void 0)?(u.enableFeedback(!0,!1),u.feedback(t),r()):n()}):(u.enableFeedback(!0,!1),u.feedback({type:"validation result",validity:"invalid",message:"You cited a non-rule as a reason.",nonRule:a.cited}),r()))}}(this))()},e}(),TemplateRule=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,OutputRule),e.prototype.className=Structure.addSubclass("TemplateRule",e),e.prototype.validateStep=function(t,e,r){var n,i,u,o,a,s,c,l,p,d,f,h,y,b,v,O,g,m,S,M,k,_;for(O=function(){var t,e,r,i;for(i=[],t=0,e=(r=this.children()).length;t<e;t++)(n=r[t]).getAttribute("premise")&&i.push(n.toOpenMath());return i}.call(this),u=[],a=0,c=(g=this.children()).length;a<c;a++)if(!(n=g[a]).getAttribute("premise")){for(s=0,l=(m=(y=OM.app.apply(OM,[OM.sym("Rule","Lurch")].concat(slice.call(function(){var t,e,r;for(r=[],t=0,e=O.length;t<e;t++)b=O[t],r.push(b.copy());return r}()),[n.toOpenMath()]))).descendantsSatisfying(function(t){return"v"===t.type})).length;s<l;s++)_=m[s],FOM.setMetavariable(_);u.push(y)}for(O=[],t instanceof OutputExpression||t.feedback({type:"validation result",validity:"invalid",message:"Conclusion is not an expression"}),f=0,p=(S=["connections","labels"]).length;f<p;f++)for(k=S[f],h=0,d=(M=t.lastCitationLookup.premises[k]).length;h<d;h++){if(i=M[h],!((v=Structure.instanceWithID(i.cited))instanceof OutputExpression))return t.feedback({type:"validation result",validity:"invalid",message:"Cited premise is not an expression",id:i.cited}),r();O.push(v)}return o=OM.app.apply(OM,[OM.sym("Rule","Lurch")].concat(slice.call(function(){var t,e,r;for(r=[],e=0,t=O.length;e<t;e++)b=O[e],r.push(b.toOpenMath());return r}()),[t.toOpenMath()])),this.setupWorker(e,{step:o.encode()},r,function(n){return function(){var i,o;return i=0,(o=function(){return i===u.length?(t.feedback({type:"validation result",validity:"invalid",message:"Cited rule does not justify the step"}),r()):n.setupWorker(e,{rule:u[i].encode()},r,function(){return e.run(function(){var e,r,n,i,u,o,a,s,c,l;if(l=OM.decode(globalData.rule),t=OM.decode(globalData.step),i=nextMatch(new Constraint(l,t)),e=null!=i&&null!=(a=i[0])?a.contents:void 0){for(c=[],u=0,n=e.length;u<n;u++)o=(s=e[u]).pattern,r=s.expression,c.push({pattern:o.encode(),expression:r.encode()});return c}return null},function(e){return null!=e.error?(t.feedback({type:"validation result",validity:"invalid",message:"Internal error in pattern matching",details:e.error}),r()):null!=e.result?(t.feedback({type:"validation result",validity:"valid"}),r()):(i++,o())})})})()}}(this))},e.prototype.setupWorker=function(t,e,r,n){var i,u,o,a,s;return i=function(t){return function(e){return t.feedback({type:"validation result",validity:"invalid",message:"Internal error setting up validation worker: could not "+e}),r()}}(this),a=function(){var t;t=[];for(u in e)hasProp.call(e,u)&&(s=e[u],t.push(u));return t}(),(o=function(){var r;return a.length>0?(r=a.shift(),t.installData(r,e[r],function(t){return null!=t.error?i("install "+r):o()})):t.run(function(){return typeof isMetavariable},function(e){var r;return null!=e.error?i("check package status"):"undefined"===e.result?(r="first-order-matching.js","undefined"!=typeof require&&null!==require&&(r="release/"+r),t.installScript(r,function(t){return null!=t.error?i("install matching package"):n()})):n()})})()},e}(),"undefined"!=typeof exports&&null!==exports&&(exports.OutputStructure=OutputStructure,exports.OutputExpression=OutputExpression,exports.OM=exports.OMNode=OM);
//# sourceMappingURL=output-structure.js.map

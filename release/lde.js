var CurrentPhase,EventEmitter,Feedback,InputModifier,InputStructure,InputTree,LDEWorker,OutputStructure,OutputTree,Structure,ValidationQueue,WorkerPool,className,classObj,deserializeIfNeeded,expectedArgumentCount,feedback,functions,isInTheInputTree,isInTheOutputTree,key,numberOfCores,os,ref,ref1,value,hasProp={}.hasOwnProperty,slice=[].slice,indexOf=[].indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(t in this&&this[t]===e)return t;return-1};if("undefined"!=typeof require&&null!==require?(os=require("os"),Structure=require("./structure").Structure,ref=require("./input-structure"),InputStructure=ref.InputStructure,InputModifier=ref.InputModifier,OutputStructure=require("./output-structure").OutputStructure,LDEWorker=require("./worker").LDEWorker):"undefined"!=typeof WorkerGlobalScope&&null!==WorkerGlobalScope?(importScripts("structure.js"),importScripts("input-structure.js"),importScripts("output-structure.js"),importScripts("worker.js")):null!=("undefined"!=typeof self&&null!==self?self.importScripts:void 0)&&(importScripts("release/structure.js"),importScripts("release/input-structure.js"),importScripts("release/output-structure.js"),importScripts("release/worker.js")),InputTree=null,functions={},functions.getInputTree=function(){return InputTree},OutputTree=null,functions.getOutputTree=function(){return OutputTree},functions.getInternalState=function(){return{inputTree:InputTree.toJSON(),outputTree:OutputTree.toJSON()}},functions.setInternalState=function(e){return null!=InputTree&&InputTree.untrackIDs(),(InputTree=Structure.fromJSON(e.inputTree)).trackIDs(),null!=OutputTree&&OutputTree.untrackIDs(),(OutputTree=Structure.fromJSON(e.outputTree)).trackIDs()},functions.reset=function(){return functions.setInternalState({inputTree:{className:"InputStructure",children:[],attributes:{id:"root"}},outputTree:{className:"OutputStructure",children:[],attributes:{id:"OT root"}}}),void 0!==WorkerPool&&null!==WorkerPool&&"function"==typeof WorkerPool.reset&&WorkerPool.reset(),void 0!==ValidationQueue&&null!==ValidationQueue&&"function"==typeof ValidationQueue.reset?ValidationQueue.reset():void 0},functions.reset(),isInTheInputTree=function(e){for(;e instanceof InputStructure;){if(e===InputTree)return!0;e=e.parent()}return!1},isInTheOutputTree=function(e){for(;e instanceof OutputStructure;){if(e===OutputTree)return!0;e=e.parent()}return!1},deserializeIfNeeded=function(e){return e instanceof InputStructure?e:Structure.fromJSON(e)},functions.insertStructure=function(e,t,r){var n,u,o,i;if(null!=(i=Structure.instanceWithID(t))&&0<=r&&r<=i.children().length&&isInTheInputTree(i)&&null!=(o=deserializeIfNeeded(e))&&o instanceof InputStructure)return(n=function(){var e,t;e=o.attributes,t=[];for(u in e)hasProp.call(e,u)&&"_"===u[0]&&t.push(u);return t}()).length>0&&o.clearAttributes.apply(o,n),i.insertChild(o,r),o.trackIDs()},functions.deleteStructure=function(e){var t;if(null!=(t=Structure.instanceWithID(e))&&isInTheInputTree(t)&&t!==InputTree)return t.removeFromParent(),t.untrackIDs()},functions.replaceStructure=function(e,t,r){var n,u,o,i;if(null==r&&(r=!1),null!=(i=Structure.instanceWithID(e))&&isInTheInputTree(i)&&i!==InputTree&&null!=(o=deserializeIfNeeded(t))&&o instanceof InputStructure)return(n=function(){var e,t;e=o.attributes,t=[];for(u in e)hasProp.call(e,u)&&"_"===u[0]&&t.push(u);return t}()).length>0&&o.clearAttributes.apply(o,n),i.replaceWith(o),r&&i.transferConnectionsTo(o),i.untrackIDs(),o.trackIDs()},functions.setStructureAttribute=function(e,t,r){var n;if("_"!==t[0])return null!=(n=Structure.instanceWithID(e))&&isInTheInputTree(n)&&("id"===t&&n.untrackIDs(!1),void 0===r?n.clearAttributes(t):n.setAttribute(t,r),"id"===t)?n.trackIDs(!1):void 0},functions.insertConnection=function(e,t,r){var n,u;return!!((n=Structure.instanceWithID(e))&&(u=Structure.instanceWithID(t))&&isInTheInputTree(n)&&isInTheInputTree(u))&&Structure.connect(n,u,r)},functions.removeConnection=function(e){return!(!isInTheInputTree(Structure.getConnectionSource(e))||!isInTheInputTree(Structure.getConnectionTarget(e)))&&Structure.disconnect(e)},functions.setConnectionAttribute=function(e,t,r){return!(!isInTheInputTree(Structure.getConnectionSource(e))||!isInTheInputTree(Structure.getConnectionTarget(e)))&&Structure.setConnectionData(e,t,r)},CurrentPhase=null,functions.runModification=function(e){var t;return CurrentPhase="modification",(t=function(e){var r,n,u,o,i;for(e instanceof InputModifier&&e.updateConnections(),i=[],n=0,u=(o=e.children()).length;n<u;n++)r=o[n],i.push(t(r));return i})(InputTree),CurrentPhase=null,functions.runInterpretation(e)},functions.runInterpretation=function(e){var t,r,n;CurrentPhase="interpretation",n=function(e){var t,r,u,o,i,a,l,c,s,p,f,d;for(u=0,a=(s=e.getConnectionsIn()).length;u<a;u++)r=s[u],isInTheOutputTree(e.getConnectionSource(r))||(e.disconnect(r),e.feedback({type:"connection removed",id:r}));for(o=0,l=(p=e.getConnectionsOut()).length;o<l;o++)r=p[o],isInTheOutputTree(e.getConnectionTarget(r))||(e.disconnect(r),e.feedback({type:"connection removed",id:r}));for(d=[],i=0,c=(f=e.children()).length;i<c;i++)t=f[i],d.push(n(t));return d},InputStructure.clearAlreadyStarted();try{(r=InputTree.recursiveInterpret())instanceof Array?r[0]instanceof OutputStructure?(OutputTree=r[0],n(OutputTree),feedback({subject:"root",type:"updated LDE state"})):feedback({subject:"root",type:"interpretation error",details:"Interpretation did not produce an OutputStructure"}):feedback({subject:"root",type:"interpretation error",details:"Interpretation did not produce an array."})}catch(e){feedback({subject:"root",type:"interpretation error",details:e})}return InputStructure.clearAlreadyStarted(),CurrentPhase=null,"function"==typeof e&&e(),(t=function(e){var r,n,u,o;for(n=0,u=(o=e.children()).length;n<u;n++)r=o[n],t(r);return"function"==typeof e.justChanged?e.justChanged():void 0})(OutputTree)},("undefined"!=typeof WorkerGlobalScope&&null!==WorkerGlobalScope||null!=("undefined"!=typeof self&&null!==self?self.importScripts:void 0))&&(expectedArgumentCount={insertStructure:[3],deleteStructure:[1],replaceStructure:[2,3],setStructureAttribute:[2,3],insertConnection:[3],removeConnection:[1],setConnectionAttribute:[2,3],getInputTree:[0],getOutputTree:[0],getInternalState:[0],setInternalState:[1],reset:[0],runModification:[0]},self.addEventListener("message",function(e){var t,r,n,u,o,i,a,l;if(o=e.data,r=o[0],t=2<=o.length?slice.call(o,1):[],i=t.length,indexOf.call(null!=(a=expectedArgumentCount[r])?a:[],i)>=0&&("getInputTree"===r?self.postMessage({type:"getInputTree",payload:functions.getInputTree().toJSON()}):"getOutputTree"===r?self.postMessage({type:"getOutputTree",payload:functions.getOutputTree().toJSON()}):functions[r].apply(functions,t)),"sendFeedback"===r)return u=t[0],n=t[1],null!=(null!=(l=Structure.instanceWithID(u))?l.feedback:void 0)?l.feedback(n):self.postMessage("No such Structure: "+u)})),"undefined"!=typeof window&&null!==window&&"undefined"!=typeof EventTarget&&null!==EventTarget&&(Feedback=window.Feedback=new EventTarget),"undefined"!=typeof require&&null!==require&&"undefined"!=typeof exports&&null!==exports&&(EventEmitter=require("events"),(Feedback=exports.Feedback=new EventEmitter).addEventListener=Feedback.addListener),feedback=function(e){var t;return null!=(null!=Feedback?Feedback.dispatchEvent:void 0)?(t=new Event("feedback"),t.data=e,Feedback.dispatchEvent(t)):null!=(null!=Feedback?Feedback.emit:void 0)?Feedback.emit("feedback",e):null!=("undefined"!=typeof self&&null!==self?self.postMessage:void 0)?self.postMessage({type:"feedback",payload:e}):void 0},Structure.feedback=feedback,WorkerPool=[],WorkerPool.setSize=function(e){var t,r;for(e=Math.max(e,1);WorkerPool.length<e;)(r=new LDEWorker).available=!0,WorkerPool.push(r);for(t=[];WorkerPool.length>e;)t.push(WorkerPool.pop());return t},WorkerPool.getAvailableWorker=function(){var e,t,r;for(e=0,t=WorkerPool.length;e<t;e++)if((r=WorkerPool[e]).available)return r.available=!1,r},WorkerPool.numberAvailable=function(){var e;return function(){var t,r,n;for(n=[],t=0,r=WorkerPool.length;t<r;t++)(e=WorkerPool[t]).available&&n.push(e);return n}().length},WorkerPool.giveWorkerBack=function(e){return e.available=!0,ValidationQueue.length>0?ValidationQueue.dequeue():WorkerPool.numberAvailable()===WorkerPool.length?feedback({subject:"OT root",type:"validation complete",details:"The validation phase just completed."}):void 0},numberOfCores=function(){var e,t,r;return null!=(e=null!=(t="undefined"!=typeof navigator&&null!==navigator?navigator.hardwareConcurrency:void 0)?t:null!=os&&"function"==typeof os.cpus&&null!=(r=os.cpus())?r.length:void 0)?e:1},WorkerPool.setSize(numberOfCores()-1),WorkerPool.reset=function(){var e,t,r,n,u;for(r=[],e=0,t=(u=function(){var e,t,r;for(r=[],e=0,t=WorkerPool.length;e<t;e++)(n=WorkerPool[e]).available||r.push(n);return r}()).length;e<t;e++)(n=u[e]).reboot(),r.push(n.available=!0);return r},ValidationQueue=[],ValidationQueue.enqueue=function(e,t){var r,n,u,o,i,a;if(null==t&&(t=0),e instanceof OutputStructure&&"function"==typeof e.validate){for(this,r=0,o=this.length;r<o;r++)if(this[r].structure===e)return;for(u=0,i=WorkerPool.length;u<i;u++)(a=WorkerPool[u]).structureBeingValidated===e&&(delete a.structureBeingValidated,a.reboot(),WorkerPool.giveWorkerBack(a));for(n=0;n<ValidationQueue.length&&ValidationQueue[n].priority<t;)n++;return ValidationQueue.splice(n,0,{structure:e,priority:t}),ValidationQueue.dequeue()}},ValidationQueue.dequeue=function(){var e,t;if(null===CurrentPhase&&ValidationQueue.length>0&&null!=(t=WorkerPool.getAvailableWorker()))return e=ValidationQueue.pop().structure,t.whenReady(function(){return t.structureBeingValidated=e,e.validate(t,function(){return delete t.structureBeingValidated,WorkerPool.giveWorkerBack(t)})})},ValidationQueue.reset=function(){return ValidationQueue.splice(0,ValidationQueue.length)},OutputStructure.prototype.instanceJustChanged=function(e){var t,r;if("function"==typeof e.validate&&null!==(t=null!=(r=this.origin)?r.getAttribute("validation priority"):void 0))return"number"!=typeof t&&(t=0),e.lastCitationLookup=e.lookUpAllCitations(),ValidationQueue.enqueue(e,t),e.feedback({type:"validation queued"})},"undefined"!=typeof exports&&null!==exports){ref1=Structure.prototype.subclasses;for(className in ref1)hasProp.call(ref1,className)&&(classObj=ref1[className],exports[className]=classObj);for(key in functions)hasProp.call(functions,key)&&(value=functions[key],exports[key]=functions[key]);exports.WorkerPool=WorkerPool,exports.ValidationQueue=ValidationQueue,exports.Worker=LDEWorker,exports.setPhase=function(e){return CurrentPhase=e}}
//# sourceMappingURL=lde.js.map

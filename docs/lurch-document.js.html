<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Lurch Web User Interface: lurch-document.js</title>
    
      <link type="text/css" rel="stylesheet" href="styles/vendor/prism-default.css">
    
    <link type="text/css" rel="stylesheet" href="styles/styles.css">
    
    
    <style>
      :root {
      
      
        --nav-width: 335px;
      
      }
    </style>
    
</head>
<body>

<header class="layout-header">
  
  <h1>
    <a href="./index.html">
      Lurch Web User Interface
    </a>
  </h1>
  <nav class="layout-nav">
    <ul><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="BoolSettingMetadata.html">BoolSettingMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="BoolSettingMetadata.html#convert">convert</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="CategorySettingMetadata.html">CategorySettingMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="CategorySettingMetadata.html#convert">convert</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="ColorSettingMetadata.html">ColorSettingMetadata</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="LurchDocument.html">LurchDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#deleteMetadata">deleteMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getDocument">getDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getMetadata">getMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getMetadataCategories">getMetadataCategories</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getMetadataKeys">getMetadataKeys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#newDocument">newDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#setDocument">setDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#setMetadata">setMetadata</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="NoteMetadata.html">NoteMetadata</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="SettingMetadata.html">SettingMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingMetadata.html#control">control</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingMetadata.html#convert">convert</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="Settings.html">Settings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#keys">keys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#load">load</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#save">save</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#userEdit">userEdit</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="SettingsCategoryMetadata.html">SettingsCategoryMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#control">control</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#defaultSettings">defaultSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#keys">keys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#metadataFor">metadataFor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="SettingsMetadata.html">SettingsMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#control">control</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#defaultSettings">defaultSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#keys">keys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#metadataFor">metadataFor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="TextSettingMetadata.html">TextSettingMetadata</a></span></li></ul><ul><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-GoogleDriveUI.html">GoogleDriveUI</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#.installDrive">installDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#~showFileOpenDialog">showFileOpenDialog</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#~showSaveAsDialog">showSaveAsDialog</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#~silentFileSave">silentFileSave</a></span></li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-GoogleDriveUtilities.html">GoogleDriveUtilities</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.ensureLoggedIn">ensureLoggedIn</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.listFilesFromFolder">listFilesFromFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.readFileFromDrive">readFileFromDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.showOpenFilePicker">showOpenFilePicker</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.showSaveFolderPicker">showSaveFolderPicker</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.updateFileInDrive">updateFileInDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.writeNewFileToDrive">writeNewFileToDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#~currentUser">currentUser</a></span></li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-SettingsInstaller.html">SettingsInstaller</a></span></li><li class="nav-item"><span class="nav-item-type type-member" title="member">M</span><span class="nav-item-name is-member"><a href="module-SettingsInstaller.html#.appSettings">appSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-SettingsInstaller.html#.installSettings">installSettings</a></span></li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-Utilities.html">Utilities</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-Utilities.html#.copyWithoutPrototype">copyWithoutPrototype</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-Utilities.html#.loadScript">loadScript</a></span></li></ul>
  </nav>
</header>


<main class="layout-main  layout-content--source">
  <div class="container">
    <p class="page-kind">source</p>
    <h1 class="page-title">lurch-document.js</h1>
    



    

<section>
    <article>
        <pre id="source" class="source-page line-numbers"><code class="language-js">
/**
 * A Lurch document will have several parts, including at least the following.
 * 
 *  * The document content as the user sees it in the editor (HTML)
 *  * Any per-document settings stored in the document as metadata (JSON)
 *  * Information about dependencies on which the document depents (the form of
 *    which has not yet been decided)
 * 
 * When stored in a filesystem, the document must contain all three of these
 * parts, but when displayed in the editor, it should show only the first of
 * them, keeping the rest somewhere outside of the user's view.  And yet those
 * other parts will be editable by the user, through a UI not yet developed.
 * And so when the document is saved, the latest versions of all three parts of
 * the document must be saved, not just the part visible in the editor.
 * 
 * This class provides a clean API for moving documents between any filesystem
 * and the editor.  It is an ephemeral/disposable class, in the sense that you
 * will often create an instance just for use in one command, and then let it be
 * garbage collected.  Examples:
 * 
 * ```js
 * // Clear out the editor, as in response to File > New:
 * new LurchDocument( editor ).newDocument()
 * // Get the document from the editor, in a form ready to save
 * // (that is, including all of its parts, not just what's visible in the UI):
 * const doc = new LurchDocument( editor ).getDocument()
 * // Load into the editor a document retrieved from a filesystem, which will
 * // have all 3 parts described above, only one of which should be shown:
 * new LurchDocument( editor ).setDocument( doc )
 * ```
 */
export class LurchDocument {

    /**
     * Construct a new instance for reading and/or writing data and metadata
     * to and/or from the given editor.
     * 
     * @param {tinymce.editor} editor the editor with which this object will
     *   interface
     */
    constructor ( editor ) {
        this.editor = editor
    }

    // Internal use only.  Clears out the editor's content.
    clearDocument () {
        this.editor.setContent( '' )
    }
    // Internal use only.  Sets up empty/new metadata structure.
    clearMetadata () {
        this.editor.lurchMetadata = this.editor.dom.doc.createElement( 'div' )
        this.editor.lurchMetadata.setAttribute( 'id', 'metadata' )
        this.editor.lurchMetadata.style.display = 'none'
    }

    /**
     * Clear out the contents of the editor given at construction time.  This
     * includes clearing out its content as well as any metdata, including
     * document settings and dependencies.
     */
    newDocument () {
        this.clearDocument()
        this.clearMetadata()
    }

    /**
     * Load the given document into the editor given at construction time.  This
     * will replace what's visible in the UI with the visible portion of the
     * given document, and will also replace the invisible document settings and
     * dependencies with those of the given document.
     * 
     * @param {string} document - the document as it was retrieved from a
     *   filesystem, ready to be loaded into this editor
     */
    setDocument ( document ) {
        // Have some off-screen element parse the HTML for us
        const temp = this.editor.dom.doc.createElement( 'div' )
        temp.innerHTML = document
        // There should be a metadata element; use it directly if so.
        const metadataElement = temp.querySelector( '#metadata' )
        if ( metadataElement )
            this.editor.lurchMetadata = metadataElement
        else
            this.clearMetadata()
        // There should be a document element; use its HTML content if so.
        const documentElement = temp.querySelector( '#metadata' )
        if ( documentElement )
            this.editor.setContent( documentElement.innerHTML )
        else
            this.clearDocument()
    }
    
    /**
     * Return the document being edited by the editor that was given at
     * construction time.  This includes its visible content as well as its
     * metdata, which includes document settings and dependencies.
     * 
     * @returns {string} the document in string form, ready to be stored in a
     *   filesystem
     */
    getDocument () {
        // Get URL to this app, without any query string
        let appURL = window.location.protocol + '//'
                   + window.location.host + window.location.pathname
        if ( !appURL.endsWith( '/' ) ) appURL += '/'
        // Get the metadata and document as HTML strings
        const metadataHTML = this.editor.lurchMetadata.outerHTML
        const documentHTML = this.editor.getContent()
        // Use those to build the result
        return `
            &lt;div id="loadlink">
                &lt;p>&lt;a>Open this file in the Lurch web app&lt;/a>&lt;/p>
                &lt;script language="javascript">
                    const link = document.querySelector( '#loadlink > p > a' )
                    const thisURL = encodeURIComponent( window.location.href )
                    link?.setAttribute( 'href', '${appURL}?load=' + thisURL )
                &lt;/script>
            &lt;/div>
            ${metadataHTML}
            &lt;div id="document">${documentHTML}&lt;/div>
        `
    }

    // Internal use only; helper functions used in several of the public API
    // functions below.
    metadataElements () {
        return Array.from( this.editor.lurchMetadata.childNodes )
            .filter( element => element instanceof HTMLDivElement )
    }
    findMetadataElement ( category, key ) {
        return this.metadataElements().find( element =>
            element.dataset.category == category
         &amp;&amp; element.dataset.key == key )
    }

    /**
     * Store a new piece of metadata in this object, or update an old one.
     * Pieces of metadata are indexed by a category-key pair, facilitating
     * "namespaces" within the metadata.  This is useful so that we can
     * partition the metadata into things like document-level settings, the
     * document's list of dependencies, data cached by algorithms in the app,
     * and any other categories that arise.
     * 
     * Values can be either JSON data (which includes strings, integers, and
     * booleans, in addition to the more complex types of JSON data) or HTML
     * in string form (for example, if you wish to store an entire dependency).
     * 
     * @param {string} category - the category for this piece of metadata
     * @param {string} key - the key for this piece of metadata
     * @param {string} valueType - either "json" or "html" to specify the format
     *   for the value
     * @param {string|Object} value - a string of HTML if `valueType` is "html"
     *   or an object we can pass to `JSON.stringify()` if `valueType` is "json"
     */
    setMetadata ( category, key, valueType, value ) {
        if ( ![ 'json', 'html' ].includes( valueType.toLowerCase() ) )
            throw new Error( 'Invalid setting value type: ' + valueType )
        const element = this.findMetadataElement( category, key )
        if ( element ) {
            element.dataset['valueType'] = valueType
            element.innerHTML = valueType == 'json' ? JSON.stringify( value ) : value
        } else {
            const newElement = this.editor.dom.doc.createElement( 'div' )
            newElement.dataset['category'] = category
            newElement.dataset['key'] = key
            newElement.dataset['valueType'] = valueType
            newElement.innerHTML = valueType == 'json' ? JSON.stringify( value ) : value
            this.editor.lurchMetadata.appendChild( newElement )
        }
    }

    /**
     * Pieces of metadata are indexed by a category-key pair, facilitating
     * "namespaces" within the metadata.  See {@link LurchDocument#setMetadata
     * setMetadata()} for more information on why.  This function looks up the
     * value that corresponds to the given category and key.
     * 
     * If the value is stored in JSON form, then the corresponding object will
     * be returned (as produced by `JSON.parse()`).  If the value is stored in
     * HTML form, then an `HTMLDivElement` instance will be returned, the
     * contents of which are the value of the metadata item.  The element
     * returned is a copy of the one stored internally, so the caller cannot
     * alter the internal value by modifying the returned element.
     * 
     * @param {string} category - the category for the piece of metadata to look
     *   up
     * @param {string} key - the key for the piece of metadata to look up
     * @returns {string|number|bool|Object|HTMLDivElement|undefined} the value
     *   stored in the metadata, or undefined if there is no such metadata
     */
    getMetadata ( category, key ) {
        const element = this.findMetadataElement( category, key )
        return !element ? undefined :
               element.dataset.valueType == 'html' ? element.cloneNode() :
               JSON.parse( element.innerHTML )
    }
    
    /**
     * Pieces of metadata are indexed by a category-key pair, facilitating
     * "namespaces" within the metadata.  See {@link LurchDocument#setMetadata
     * setMetadata()} for more information on why.  This function returns all
     * categories that appear in the document's metadata.  There is no defined
     * order to the result, but no category is repeated.  The list may be empty
     * if this document has no metadata stored in it.
     * 
     * @returns {string[]} an array containing all strings that appear as
     *   categories in this document's metadata
     */
    getMetadataCategories () {
        const result = [ ]
        this.metadataElements().forEach( element => {
            if ( !result.contains( element.dataset.category ) )
                result.push( element.dataset.category )
        } )
        return result
    }

    /**
     * Pieces of metadata are indexed by a category-key pair, facilitating
     * "namespaces" within the metadata.  See {@link LurchDocument#setMetadata
     * setMetadata()} for more information on why.  This function returns all
     * keys that appear in the document's metadata under a given category.
     * There is no defined order to the result, but no key is repeated.  The
     * list may be empty if this document has no metadata stored in it under the
     * given category.
     * 
     * @param {string} category - the category whose keys should be listed
     * @returns {string[]} the keys corresponding to the given category
     */
    getMetadataKeys ( category ) {
        const result = [ ]
        this.metadataElements().forEach( element => {
            if ( element.dataset.category == category
              &amp;&amp; !result.contains( element.dataset.key ) )
                result.push( element.dataset.key )
        } )
        return result
    }

    /**
     * Pieces of metadata are indexed by a category-key pair, facilitating
     * "namespaces" within the metadata.  See {@link LurchDocument#setMetadata
     * setMetadata()} for more information on why.  This function deletes the
     * unique metadata item stored under the given category-key pair if there is
     * one, and does nothing otherwise.
     * 
     * @param {string} category - the category for the piece of metadata to
     *   delete
     * @param {string} key - the key for the piece of metadata to delete
     */
    deleteMetadata ( category, key ) {
        const element = this.findMetadataElement( category, key )
        if ( element ) element.remove()
    }

}
</code></pre>
    </article>
</section>




  </div>
</main>

<footer class="layout-footer">
  <div class="container">
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a>
  </div>
</footer>



<script src="scripts/prism.dev.js"></script>
</body>
</html>

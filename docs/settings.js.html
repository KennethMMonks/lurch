<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Lurch Web User Interface: settings.js</title>
    
      <link type="text/css" rel="stylesheet" href="styles/vendor/prism-default.css">
    
    <link type="text/css" rel="stylesheet" href="styles/styles.css">
    
    
    <style>
      :root {
      
      
        --nav-width: 335px;
      
      }
    </style>
    
</head>
<body>

<header class="layout-header">
  
  <h1>
    <a href="./index.html">
      Lurch Web User Interface
    </a>
  </h1>
  <nav class="layout-nav">
    <ul><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="BoolSettingMetadata.html">BoolSettingMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="BoolSettingMetadata.html#convert">convert</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="CategorySettingMetadata.html">CategorySettingMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="CategorySettingMetadata.html#convert">convert</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="ColorSettingMetadata.html">ColorSettingMetadata</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="LurchDocument.html">LurchDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#deleteMetadata">deleteMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getDocument">getDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getMetadata">getMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getMetadataCategories">getMetadataCategories</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#getMetadataKeys">getMetadataKeys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#newDocument">newDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#setDocument">setDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="LurchDocument.html#setMetadata">setMetadata</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="NoteMetadata.html">NoteMetadata</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="SettingMetadata.html">SettingMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingMetadata.html#control">control</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingMetadata.html#convert">convert</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="Settings.html">Settings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#has">has</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#keys">keys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#load">load</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#save">save</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="Settings.html#userEdit">userEdit</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="SettingsCategoryMetadata.html">SettingsCategoryMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#control">control</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#defaultSettings">defaultSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#keys">keys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsCategoryMetadata.html#metadataFor">metadataFor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="SettingsMetadata.html">SettingsMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#control">control</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#defaultSettings">defaultSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#keys">keys</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="SettingsMetadata.html#metadataFor">metadataFor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class" title="class">C</span><span class="nav-item-name is-class"><a href="TextSettingMetadata.html">TextSettingMetadata</a></span></li></ul><ul><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-Downloader.html">Downloader</a></span></li><li class="nav-item"><span class="nav-item-type type-member" title="member">M</span><span class="nav-item-name is-member"><a href="module-Downloader.html#.installDownloader">installDownloader</a></span></li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-GoogleDriveUI.html">GoogleDriveUI</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#.installDrive">installDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#~showFileOpenDialog">showFileOpenDialog</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#~showSaveAsDialog">showSaveAsDialog</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUI.html#~silentFileSave">silentFileSave</a></span></li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-GoogleDriveUtilities.html">GoogleDriveUtilities</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.ensureLoggedIn">ensureLoggedIn</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.listFilesFromFolder">listFilesFromFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.readFileFromDrive">readFileFromDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.showOpenFilePicker">showOpenFilePicker</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.showSaveFolderPicker">showSaveFolderPicker</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.updateFileInDrive">updateFileInDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#.writeNewFileToDrive">writeNewFileToDrive</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-GoogleDriveUtilities.html#~currentUser">currentUser</a></span></li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-SettingsInstaller.html">SettingsInstaller</a></span></li><li class="nav-item"><span class="nav-item-type type-member" title="member">M</span><span class="nav-item-name is-member"><a href="module-SettingsInstaller.html#.appSettings">appSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-SettingsInstaller.html#.installSettings">installSettings</a></span></li><li class="nav-heading"><span class="nav-item-type type-module" title="module">M</span><span class="nav-item-name is-module"><a href="module-Utilities.html">Utilities</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-Utilities.html#.copyWithoutPrototype">copyWithoutPrototype</a></span></li><li class="nav-item"><span class="nav-item-type type-function" title="function">F</span><span class="nav-item-name is-function"><a href="module-Utilities.html#.loadScript">loadScript</a></span></li></ul>
  </nav>
</header>


<main class="layout-main  layout-content--source">
  <div class="container">
    <p class="page-kind">source</p>
    <h1 class="page-title">settings.js</h1>
    



    

<section>
    <article>
        <pre id="source" class="source-page line-numbers"><code class="language-js">
/**
 * A class representing the values of the user's settings in an app.  Instances
 * of this class require metadata so that the settings can be presented to the
 * user in a dialog for editing.
 * 
 * The class inherits from `Map`, which allows you to call `keys()`, `has(key)`,
 * `get(key)`, `set(key,value)`, `delete(key)`, and `clear()`.  We augment this
 * built-in functionality with additional methods for loading, saving, and
 * allowing the user to edit the settings interactively.
 */
export class Settings extends Map {

    /**
     * Construct a collection of settings with the given name and metadata.
     * Only settings whose metadata appear in the given `metadata` will be used
     * for load, save, or editing purposes.  (You can `.set()` other things, but
     * this class will ignore them.)
     * 
     * @param {String} name - the name of this collection of settings, which
     *   will be shown to the user in the title of the dialog box presented when
     *   editing the settings
     * @param {SettingsMetadata} metadata - the metadata definitions for all
     *   settings that will be stored in this object
     */
    constructor ( name, metadata ) {
        super()
        this.name = name
        this.metadata = metadata
        this.defaults = metadata.defaultSettings()
    }

    /**
     * This should be viewed as the set of allowed keys for this app's settings.
     * They are the keys that show up in the metadata, and are thus the only
     * keys that this object pays attention to (even if you add settings with
     * other names).
     * 
     * @returns {String[]} the keys from the metadata for these settings; see
     *   {@link SettingsMetadata#keys SettingsMetadata.keys()} for more
     *   information
     */
    keys () { return this.metadata.keys() }

    /**
     * A settings object has a key if and only if that key appears as part of
     * its metadata, which was given at construction time.  Even if no value has
     * been assigned for the key, the settings object still has it, associated
     * with its default value.  Even if other keys have been set, we ignore them
     * because they do not appear in the schema given at construction time.
     * 
     * @param {string} key - the key whose presence should be checked
     * @returns {boolean} whether the key appears in this settings object
     */
    has ( key ) { return this.keys().includes( key ) }

    /**
     * If the given key does not appear in the metadata given at construction
     * time, then undefined is returned.  Otherwise, if the key has had a value
     * associated with it via a previous call to `set()`, then we return that
     * value.  Otherwise, we return the default value given in the metadata for
     * the given key.
     * 
     * @param {string} key - the key to look up
     * @returns {any} the value stored under the key, or the default value for
     *   that key if none has yet been set
     */
    get ( key ) {
        return !this.has( key ) ? undefined :
               super.has( key ) ? super.get( key ) : this.defaults[key]
    }

    /**
     * Load from the browser's `localStorage` all settings whose names show up
     * in this object's metadata, and convert them to the appropriate types using
     * that metadata.  For any value not in `localStorage`, fill this object
     * with its default value instead (as given by the metadata).
     */
    load () {
        const allowedKeys = this.keys()
        for ( let i = 0 ; i &lt; localStorage.length ; i++ ) {
            const key = localStorage.key( i )
            if ( !key.startsWith( 'lurch-' ) ) continue
            const subkey = key.substring( 6 )
            if ( allowedKeys.includes( subkey ) ) {
                const metadata = this.metadata.metadataFor( subkey )
                const loaded = localStorage.getItem( key )
                this.set( subkey, metadata ? metadata.convert( loaded ) : loaded )
            }
        }
    }

    /**
     * For every setting that is stored in this object and whose key is allowed,
     * according to this object's metadata, save the key-value pair into the
     * browser's `localStorage` object.
     */
    save () {
        this.keys().forEach( key => {
            if ( this.has( key ) )
                localStorage.setItem( `lurch-${key}`, this.get( key ) )
        } )
    }

    /**
     * Show to the user a dialog box for editing this settings object.  If the
     * user clicks OK, any changes they made will be saved back into this
     * object.  If the user clicks cancel, no changes they made in the dialog
     * will be retained or stored in this object or anywhere else.
     * 
     * Returns a promise as described below.  Note that if the user edits the
     * settings and closes the dialog, that impacts the contents of this object,
     * but not the contents of the browser's `localStorage`.  If the client
     * wishes the new settings to be saved, they should call this object's
     * `save()` function when the promise resolves.
     * 
     * The promise resolves whether the user clicks OK or cancel, but in the
     * case of cancel, an empty array is passed (no settings changed).  The
     * promise rejects only if some unexpected error occurs; that would be
     * considered a bug, so the intent is for the promise to always resolve.
     * 
     * @param {tinymce.Editor} editor - the editor in which to show the dialog
     * @returns {Promise} a promise that resolves when the user closes the
     *   dialog, and passes an array of all setting names that the user changed.
     */
    userEdit ( editor ) {
        const originalSettings = { }
        Array.from( this.keys() ).forEach( key =>
            originalSettings[key] = this.has( key ) ? this.get( key )
                                                    : this.defaults[key] )
        return new Promise( ( resolve, reject ) => {
            const dialog = editor.windowManager.open( {
                title : this.name,
                size : 'medium',
                body : this.metadata.control(),
                buttons : [
                    { text : 'OK', type : 'submit' },
                    { text : 'Cancel', type : 'cancel' }
                ],
                initialData : originalSettings,
                onSubmit : () => {
                    const results = dialog.getData()
                    dialog.close()
                    const changedKeys = Object.keys( results ).filter(
                        key => results[key] != originalSettings[key] )
                    changedKeys.forEach( key => this.set( key, results[key] ) )
                    resolve( changedKeys )
                },
                onCancel : () => resolve( [ ] ) // nothing changed (cancel)
            } )
        } )
    }
    
}
</code></pre>
    </article>
</section>




  </div>
</main>

<footer class="layout-footer">
  <div class="container">
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a>
  </div>
</footer>



<script src="scripts/prism.dev.js"></script>
</body>
</html>
